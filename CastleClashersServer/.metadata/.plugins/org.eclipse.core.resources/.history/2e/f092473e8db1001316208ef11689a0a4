//http://jwebsocket.org/javadocs/jWebSocketServerAPI/apidocs/org/jwebsocket/api/package-summary.html

package com.threeC.server;

import org.json.JSONException;
import org.json.JSONObject;
import org.jwebsocket.factory.JWebSocketFactory;
import org.jwebsocket.server.TokenServer;
import org.jwebsocket.token.JSONToken;
import org.jwebsocket.token.Token;
import org.jwebsocket.kit.WebSocketServerEvent;
import org.jwebsocket.listener.WebSocketServerTokenEvent;
import org.jwebsocket.listener.WebSocketServerTokenListener;
import org.jwebsocket.api.WebSocketConnector;
import org.jwebsocket.api.WebSocketEngine;
import org.jwebsocket.api.WebSocketServerListener;
import org.jwebsocket.api.WebSocketPacket;
import org.jwebsocket.config.JWebSocketConfig;
import org.jwebsocket.instance.JWebSocketInstance;
import org.jwebsocket.packetProcessors.JSONProcessor;

class JWebSocketListener implements WebSocketServerTokenListener {	
	
	@Override
	public void processOpened(WebSocketServerEvent event) {		
		System.out.println("Connection Opened");
	}
	
	@Override
	public void processPacket(WebSocketServerEvent event, WebSocketPacket packet) {
		//System.out.println(packet.getString() + "|" + packet.getASCII() + "|" + packet.getUTF8());
		//System.out.println(packet.size());		
		try {
			JSONObject o = JSONProcessor.tokenToJSON(JSONProcessor.packetToToken(packet));
			//System.out.println("Packet: " + o.toString());			
		} catch (JSONException e) {
			e.printStackTrace();
		}			
	}
	
	@Override
	public void processClosed(WebSocketServerEvent event) {
		System.out.println("Connection Closed");
	}
	
	@Override
	public void processToken(WebSocketServerTokenEvent event, Token token){  
		System.out.println(token.toString());
	} 
}

public class ServerMain {
	public static void main(String[] args){
		JWebSocketFactory.printCopyrightToConsole();
		JWebSocketConfig.initForConsoleApp(args);
		JWebSocketFactory.start();
		TokenServer server = (TokenServer)JWebSocketFactory.getServer("ts0");
		
		assert server != null;

		server.addListener(new JWebSocketListener());		
		while (JWebSocketInstance.getStatus() != JWebSocketInstance.SHUTTING_DOWN){
			try {
				for(WebSocketEngine wse : server.getEngines().values()) {
					for(WebSocketConnector wsc : server.getConnectors(wse).values()) {
						//System.out.println(wsp);
						//JSONToken t = new JSONToken();
						//t.put("the", "try again");
						//server.sendToken(wsp, JSONProcessor.JSONStringToToken("{ 'the' : 'best' } "));
						JSONObject o = new JSONObject();
						try {
							o.put("the", 1000);
						} catch (JSONException e) {
							e.printStackTrace();
						}
						
						server.sendPacket(wsc, JSONProcessor.tokenToPacket(JSONProcessor.JSONStringToToken(o.toString())));
						
						//wsp.sendPacket(JSONProcessor.tokenToPacket(t));
					}
				}
				Thread.sleep(250);
			} catch (InterruptedException e) {}
		}
		System.out.println("Server shutting down...");
	}
}
